<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>

    <canvas id="canvas" width="640" height="480">
    </canvas>

    <pre id="textarea"></pre>

    <script src="script.js"></script>
    <script src="phonemes.js"></script>
    <script>

        var last = 0;

        Array.prototype.pick_random = function() {
            return this[rand(0, this.length)];
        };

        function clamp(value, min, max) {
            if (value < min) return min;
            if (value >= max) return max;
            return value;
        }

        function rand(min, max) {
            return Math.floor(Math.random() * (max - min) + min);
        }

        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                let j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function getDistance(a, b) {
            var dx = b.x - a.x;
            var dy = b.y - a.y;
            return Math.sqrt(dx * dx + dy * dy);
        }

        function random_name() {
            var name = "";
            var length = rand(2,5);
            for (var i=0; i<length; i++) {
                name += phonemes.pick_random()
            }
            return name;
        }

        function checkBattle() {
            if (friendlies === 0) {
                console.log("You lose!");
                return false;
            }
            if (enemies === 0) {
                console.log("You win!");
                return false;
            }
            return true;
        }

        function create_unit(party, job) {
            var unit = new Unit(party, job);
            party.add(unit, player);
            q.add(unit);
            units.push(unit);
            map.addUnit(unit);
        }

        function update(timestamp) {

            if (Math.floor(timestamp / 100) > last) { //one tick per second

                if (checkBattle()) {
                    q.update(map);
                }

                last = Math.floor(timestamp / 100);
            }

            sprites.forEach(function(sprite) {
                sprite.update();
            });

            draw();
            window.requestAnimationFrame(update);
        }

        function draw() {
            context.fillStyle = "skyblue";
            context.fillRect(0,0,640,480);

            map.draw(context, q.next);

            sprites.forEach(function(sprite) {
                if (!sprite.dead) {
                    sprite.draw(context);
                }
            });

            context.font = "12px monospace";
            context.fillStyle = "rgb(255,255,0)";
            context.fillText(`Friendlies: ${friendlies}`, 0, 0);
            context.fillText(`Enemies: ${enemies}`, 0, 12);
        }

        var canvas, context;
        var textarea = document.getElementById("textarea");
        var sprites = [];
        var q, map;

        var units = [];
        var parties = [];
        var friendlies = 0;
        var enemies = 0;

        var player = new Party("player", "rgb(0,255,255)");
        var cpu = new Party("cpu", "rgb(255,0,255)");

        var activeUnit = null;

        window.onload = function() {
            canvas = document.getElementById("canvas");
            context = canvas.getContext("2d");
            context.textBaseline = "top";

            q = new Queue();
            map = new BattleMap(16, 16);

            create_unit(player, "fighter");
            create_unit(player, "fighter");
            create_unit(player, "fighter");
            create_unit(player, "archer");
            create_unit(player, "archer");

            create_unit(cpu, "fighter");
            create_unit(cpu, "fighter");
            create_unit(cpu, "archer");
            create_unit(cpu, "archer");
            create_unit(cpu, "archer");

            friendlies = player.units.length
            enemies = cpu.units.length;

            update();
        };

    </script>

</body>


</html>